---
title: "Introdução ao geocodebr"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
code-annotations: hover
urlcolor: blue
vignette: >
  %\VignetteIndexEntry{Introdução ao geocodebr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = identical(tolower(Sys.getenv("NOT_CRAN")), "true"),
  out.width = "100%"
)
```

A geolocalização refere-se ao ato de encontrar um ponto no espaço, geralmente representado por um par de coordenadas, a partir de uma informação de endereço. O pacote **{geocodebr}** permite geolocalizar endereços brasileiros de forma simples e eficiente, utilizando como referências dados públicos de endereços do Brasil. A principal base de referência é o Cadastro Nacional de Endereços para Fins Estatísticos (CNEFE), um conjunto de dados coletado e [publicado](https://www.ibge.gov.br/estatisticas/sociais/populacao/38734-cadastro-nacional-de-enderecos-para-fins-estatisticos.html) pelo Instituto Brasileiro de Geografia e Estatística (IBGE), que contém os endereços de mais de 110 milhões de domicílios e estabelecimentos no país.



## Instalação

Antes de usar o **{geocodebr}**, certifique-se de que ele está instalado no seu computador. Você pode baixar a versão mais estável do CRAN...

```{r, eval = FALSE}
install.packages("geocodebr")
```

... ou a versão em desenvolvimento no GitHub.

```{r, eval = FALSE}
# install.packages("pak")
pak::pak("ipeaGIT/geocodebr")
```

Then attach it to the current R session:


## Utilização

The main function of package is `geocode()`, which
takes a data frame of addresses as input and outputs the same data frame with
the latitude and longitude of each matched address, as well as two columns
indicating the precision level of the matches. To demonstrate its usage, the
package includes a few sample data sets in the installation. In the example
below, we use a small data set that contains addresses with commonly seen
issues, such as missing information and mistyped fields.

A principal função do pacote é a `geocode()`, que recebe uma tabela (`data.frame`) de endereços como entrada e retorna a mesma tabela acrescida com as colunas de latitude e longitude de cada endereço correspondido, além de  colunas indicando o nível de precisão dos resultados. Para demonstrar seu uso, o pacote inclui alguns conjuntos de dados de exemplo na instalação. No exemplo abaixo, utilizamos um pequeno conjunto de dados que contém endereços com problemas comuns, como informações ausentes e campos digitados incorretamente.

**Nota:** A execução da função `geocode()`pela primeira vez pode demorar, pois o **{geocodebr}** precisa baixar os dados de endereços, que somam cerca de 5,5 GB. Esses dados são armazenados localmente, portanto, o download é feito apenas uma vez. Mais informações sobre o armazenamento em cache dos dados estão disponíveis abaixo.

```{r}
library(geocodebr)

df <- read.csv(
  system.file("extdata/small_sample.csv", package = "geocodebr")
)

# Primeiro passo: inidicar o nome das colunas com cada campo dos enderecos
campos <- geocodebr::listar_campos(
  logradouro = "nm_logradouro",
  numero = "Numero",
  cep = "Cep",
  localidade = "Bairro",
  municipio = "nm_municipio",
  estado = "nm_uf"
  )

# Segundo passo: geolocalizar
df_geo <- geocodebr::geocode(
  enderecos = df,
  campos_endereco = campos,
  resultado_completo = FALSE,
  verboso = TRUE,
  cache = TRUE,
  n_cores = 1
  )


head(df_geo)
```

As coordendas espaciais do output usam sistema de referência ofical do Brasil: SIRGAS2000, CRS(4674). Os resultados do {geocodebr} são classificados em seis amplas categorias de precisão, dependendo de quão exatamente cada endereço de entrada foi correspondido com os dados do CNEFE. O grau de precisão é indicado em duas colunas da tabela de output: `precisao` e `tipo_resultado`. Mais informações abaixo.


# Precissão dos resultados:

Os resultados do **{geocodebr}** são classificados em seis categorias gerais de `precisao`, dependendo do nível de exatidão com que cada endereço de input foi encontrado nos dados do CNEFE:

- "numero"
- "numero_aproximado"
- "logradouro"
- "cep"
- "localidade"
- "municipio"
- `NA` (not found)

Cada nível de precisão pode ser desagregado em tipos de correspondência mais refinados.

## Tipos de resultados

A coluna `tipo_resultado` fornece informações mais detalhadas sobre como exatamente cada endereço de entrada foi encontrado no CNEFE. Em cada categoria, o **{geocodebr}** calcula a média da latitude e longitude  dos endereços incluídos no CNEFE que correspondem ao endereço de entrada, com base em combinações de diferentes campos. No caso mais rigoroso, por exemplo, a função encontra uma correspondência determinística para todos os campos de um dado endereço (`"estado"`, `"municipio"`, `"logradouro"`, `"numero"`, `"cep"`, `"localidade"`). Pense, por exemplo, em um prédio com vários apartamentos que correspondem ao mesmo endereço de rua e número. Nesse caso, as coordenadas dos apartamentos podem diferir ligeiramente, e o **{geocodebr}** calcula a média dessas coordenadas. Em um caso menos rigoroso, no qual apenas os campos (`"estado"`, `"municipio"`, `"logradouro"`, `"localidade"`) são encontrados, o **{geocodebr}** calcula as coordenadas médias de todos os endereços no CNEFE ao longo daquela rua e que se encontram na mesma localidade/bairro. Assim, as coordenadas de resultado tendem a ser o ponto médio do trecho daquela rua que passa dentro daquela localidade/bairro.

A lista completa dos níveis de precisão (`precisao`), suas categorias de tipo de correspondência (`tipo_resultado`) e os campos de endereço considerados em cada categoria estão descritos abaixo:


- precisao: **"numero"**
  - tipo_resultado:
    - en01: logradouro, numero, cep e localidade
    - en02: logradouro, numero e cep
    - en03: logradouro, numero e localidade
    - en04: logradouro e numero
    - pn01: logradouro, numero, cep e localidade
    - pn02: logradouro, numero e cep
    - pn03: logradouro, numero e localidade
    - pn04: logradouro e numero

- precisao: **"numero_interpolado"**
  - tipo_resultado:
    - ei01: logradouro, numero, cep e localidade
    - ei02: logradouro, numero e cep
    - ei03: logradouro, numero e localidade
    - ei04: logradouro e numero
    - pi01: logradouro, numero, cep e localidade
    - pi02: logradouro, numero e cep
    - pi03: logradouro, numero e localidade
    - pi04: logradouro e numero

- precisao: **"logradouro"** (when input number is missing 'S/N')
  - tipo_resultado:
    - er01: logradouro, cep e localidade
    - er02: logradouro e cep
    - er03: logradouro e localidade
    - er04: logradouro
    - pr01: logradouro, cep e localidade
    - pr02: logradouro e cep
    - pr03: logradouro e localidade
    - pr04: logradouro

- precisao: **"cep"**
  - tipo_resultado:
    - ec01: municipio, cep, localidade
    - ec02: municipio, cep

- precisao: **"localidade"**
  - tipo_resultado:
    - eb01: municipio, localidade

- precisao: **"municipio"**
  - tipo_resultado:
    - em01: municipio


***Nota:*** As categorias de `match_type` que começam com 'p' utilizam correspondência probabilística do campo logradouro, enquanto os tipos que começam com 'e' utilizam apenas correspondência determinística. **As categorias de `match_type` que usam correspondência probabilística ainda não estão implementados no {geocodebr}**.



# Cache de dados

A primeira vez que o usuário executa a função `geocode()`, o **{geocodebr}** fará o download de alguns arquivos de referência e os armazenará localmente. Dessa forma, os dados precisam ser baixados apenas uma vez. É importante notar que esses arquivos exigem aproximadamente 5,5 GB de espaço no seu disco local.


O pacote inclui as seguintes funções para ajudar os usuários a gerenciar os arquivos em cache:

- `listar_pasta_cache()`: retorna o caminho onde os dados em cache estão armazenados. Por padrão, os arquivos são armazenados no diretório do pacote.
- `definir_pasta_cache()`: define um diretório personalizado para ser utilizado. Essa configuração é persistente entre diferentes sessões do R.
- `listar_dados_cache()`: lista todos os arquivos atualmente armazenados em cache.
- `deletar_pasta_cache()`: exclui todos os arquivos do diretório de cache utilizado pelo **{geocodebr}**.



